# Gemini Cost Estimation Procedures

This document outlines how to accurately estimate costs for `tell-me` sessions using the `.log` files and YAML configurations.

## 1. Identify Model & Rates
First, check the `MODE` and `AIMODEL` in your configuration (e.g., `output/last-assist-vertex.config.yaml`).

### Gemini 3 Pro Preview
*   **Input (New/Miss):** $2.00 / 1M tokens
*   **Input (Cached/Hit):** $0.20 / 1M tokens
*   **Output/Thinking:** $12.00 / 1M tokens
*   **Grounding (Search):** ~$0.014 per query (after 5k/month free)

### Gemini 3 Flash Preview
*   **Input (New/Miss):** $0.10 / 1M tokens
*   **Input (Cached/Hit):** $0.01 / 1M tokens
*   **Output/Thinking:** $0.40 / 1M tokens
*   **Grounding (Search):** ~$0.014 per query (after 5k/month free)

---

## 2. Parsing the Log File
Open the corresponding `.log` file (e.g., `output/last-assist-vertex.json.log`). Each line represents one turn:
`[Time] H: <Hit> M: <Miss> C: <Completion> T: <Total> N: <New> S: <Search> Th: <Thinking>`

1.  **H (Hit):** Cached tokens. Cost is negligible but calculated at the "Cached" rate.
2.  **N (New):** This is the billable input for that specific turn.
3.  **C (Completion):** Output tokens generated by the model.
4.  **Th (Thinking):** Internal reasoning tokens. These are billed at the **Output** rate.
5.  **S (Search):** Number of Google Search queries performed.

---

## 3. Calculation Formula

### Scenario A: Grounding Disabled (`USE_SEARCH: false`)
The model uses context caching. `H` (Hits) will be high, and `N` (New) will be low.
```text
Total Cost = (Sum of N * InputRate) + (Sum of H * CachedRate) + (Sum of (C + Th) * OutputRate)
```

### Scenario B: Grounding Enabled (`USE_SEARCH: true`)
Context caching is disabled by the API. `H` will always be 0. `N` (New) will represent the full context + new prompt.
```text
Total Cost = (Sum of N * InputRate) + (Sum of (C + Th) * OutputRate) + (Sum of S * SearchRate)
```

---

## 4. Step-by-Step Execution
1.  **Aggregate Totals:** Run the following command to get the sums from your log:
    ```bash
    awk -F' ' '{h+=$3; n+=$11; c+=$5; s+=$13; th+=$15} END {print "H:",h,"N:",n,"C:",c,"S:",s,"Th:",th}' output/your-log-file.log | sed 's/[A-Z]://g'
    ```
2.  **Apply Rates:** Multiply the resulting totals by the rates identified in Step 1.
3.  **Sum Values:** Add Input, Cached, Output, and Search costs for the final USD total.

